!function(e){"use strict";e.fn.easyGrid=function(t){function a(e){var t=e.data("easyGridConf"),a=parseInt(t.dataFlag,10),n=t.showHeader,s=t.showOperateCol,d=t.showSelectCol,r=t.data,l=r.length,c='<div class="easy-grid">';if(0===a){var f,u=t.colKey,h={colKey:u,showSelectCol:d,showOperateCol:s,operateCol:t.operateCol,valMap:t.valMap};if("false"===n.toString())0!==l?c+=o(r,h):(f={},u.forEach(function(e){f[e]=""}),c+=o([f],h));else{var y=t.header;c+=i(y,d,s,t.operateCol),0!==l?c+=o(r,h):(f={},u.forEach(function(e){f[e]=""}),c+=o([f],h,!0))}}else console.log("源数据是二维数组");c+="</div>",e.html(c)}function i(e,t,a,i){if("undefined"==typeof e)return"";var o='<div class="easy-grid-header"><div class="easy-grid-row">';return"true"===t.toString()&&(o+='<div class="easy-grid-col col-select"><input type="checkbox" class="select-row select-row-all"></div>'),e.forEach(function(e){o+='<div class="easy-grid-col col-default">'+e+"</div>"}),"true"===a.toString()&&(o+='<div class="easy-grid-col col-operate">'+i.header+"</div>"),o+="</div></div>"}function o(e,t,a){var i=t.colKey,o=t.showOperateCol,n=t.showSelectCol,s=t.operateCol,d=t.valMap,r="",l="",c="",f="";"undefined"!=typeof s&&("undefined"!=typeof s.update&&(r=s.update.text||""),"undefined"!=typeof s.del&&(l=s.del.text||""),"undefined"!=typeof s.save&&(c=s.save.text||""),"undefined"!=typeof s.cancel&&(f=s.cancel.text||""));var u='<div class="easy-grid-body">';return"undefined"==typeof i?console.log("源数据是二维数组"):e.forEach(function(e){if(u+=a?'<div class="easy-grid-row grid-row-model">':'<div class="easy-grid-row">',"true"===n.toString()&&(u+='<div class="easy-grid-col col-select"><input type="checkbox" class="select-row"></div>'),d){var t;i.forEach(function(a){d.hasOwnProperty(a)?(t=d[a][e[a]],u+='<div class="easy-grid-col col-default" data-key="'+a+'" data-val="'+e[a]+'">'+(t?t:e[a])+"</div>"):u+='<div class="easy-grid-col col-default" data-key="'+a+'" data-val="'+e[a]+'">'+e[a]+"</div>"})}else i.forEach(function(t){u+='<div class="easy-grid-col col-default" data-key="'+t+'" data-val="'+e[t]+'">'+e[t]+"</div>"});"true"===o.toString()&&(u+='<div class="easy-grid-col col-operate"><button class="btn btn-operate btn-update">'+r+'</button><button class="btn btn-operate btn-del">'+l+'</button><button class="btn btn-operate btn-save">'+c+'</button><button class="btn btn-operate btn-cancel">'+f+'</button><button class="btn btn-operate btn-undo">'+f+"</button></div>"),u+="</div>"}),u+="</div>"}function n(t){var a=t.data("easyGridConf"),i=a.showSelectCol.toString(),o=a.showOperateCol.toString(),n=a.colWidth;if("undefined"!=typeof n){if(e.isArray(n)){var s=0,d=a.selectColWidth;try{s=a.operateCol.width}catch(e){console.log(e)}var r;t.find(".easy-grid-row").each(function(){r=e(this),r.children(".col-default").each(function(t){0===parseInt(n[t],10)&&e(this).addClass("hide"),this.style.width=n[t]}),"true"===i&&(r.children(".col-select")[0].style.width=d),"true"===o&&(r.children(".col-operate")[0].style.width=s)})}t.find(".btn-save, .btn-cancel, .btn-undo").hide()}}function s(t){var a=t.data("easyGridConf"),i=a.showOperateCol,o=a.showSelectCol,n=a.delRowsSelector,s=a.showAddRow;if("true"===i.toString()){var r=a.operateCol.save.fn,l=a.operateCol.del.fn;c(t,a.primaryKey),y(t),u(t,l),h(t,r),"true"===s.toString()&&d(t,e(a.addRowSelector),a.addRowPosition)}if("true"===o.toString()){v(t);var f=e(n);0!==f.length&&g(t,f)}}function d(t,a,i){a.on("click",function(){if(!e(this).hasClass("off")){e(this).addClass("off");var a=t.find(".easy-grid-body");r(t,a,i)}})}function r(t,a,i){var o;o="start"===i?a.children(".easy-grid-row:eq(0)").clone(!0).removeClass("grid-row-model"):a.children(".easy-grid-row:last").clone(!0).removeClass("grid-row-model");var n,s,d=t.data("easyGridConf").addRowPrimaryKey,r=t.data("easyGridConf").addRowPrimaryKeyDefaultVal;o.hasClass("row-editable")?(o.find(".edit-status").val("").attr("placeholder","").end().find(".btn-cancel").hide().siblings(".btn-undo").show(),o.find(".col-default").each(function(){n=e(this),s=e.inArray(n.attr("data-key"),d),s===-1?n.children(".edit-status").removeAttr("disabled"):n.children(".edit-status").val(r[s])}),"start"===i?o.prependTo(a):a.append(o),o.find(".edit-status:eq(0)").focus(),l(t)):(o.addClass("row-editable").find(".col-default").each(function(){n=e(this),s=e.inArray(n.attr("data-key"),d),s===-1?n.html('<input type="text" class="edit-status" placeholder="">'):n.html('<input type="text" class="edit-status" disabled title="该项不可修改" placeholder="">').find(".edit-status").val(r[s])}).siblings(".col-operate").find(".btn-update, .btn-del, .btn-cancel").hide().siblings(".btn-save, .btn-undo").show(),"start"===i?o.prependTo(a):a.append(o),o.find(".edit-status:eq(0)").focus(),l(t),f(t))}function l(t){t.find(".btn-undo").on("click",function(){e(this).closest(".easy-grid-row").animate({height:0,opacity:0},300,function(){try{e(t.data("easyGridConf").addRowSelector).removeClass("off")}catch(e){console.warn(e)}e(this).remove()})})}function c(t,a){var i,o,n;t.find(".btn-update").on("click",function(){n=e(this),n.hide().siblings(".btn-del").hide().siblings(".btn-save, .btn-cancel").show().closest(".col-operate").siblings(".col-default").each(function(){i=e(this),o=i.text(),e.inArray(i.attr("data-key"),a)>-1?i.html('<input type="text" class="edit-status" disabled title="该项不可修改" placeholder="'+o+'">').children(".edit-status").val(o):i.html('<input type="text" class="edit-status can-update" placeholder="'+o+'">').children(".edit-status").val(o)}),n.closest(".easy-grid-row").addClass("row-editable").find(".edit-status.can-update:eq(0)").focus().select(),f(t)})}function f(t){var a=t.data("easyGridConf").verification;e(".edit-status").on("keyup",function(t){var i=e(this),o=i.parent(".easy-grid-col").attr("data-key");a.hasOwnProperty(o)&&(a[o].pattern.test(i.val())?i.removeClass("invalid").attr("title",""):i.addClass("invalid").attr("title",a[o].tips))})}function u(t,a){t.find(".btn-del").on("click",function(){if("function"==typeof a){var i=e(this).closest(".easy-grid-row"),o=p(i),n=a(o);n?e(this).closest(".easy-grid-row").animate({height:0,opacity:0},300,"swing",function(){e(this).remove()}):console.warn("删除失败")}var s=t.data("easyGridConf").deletedCallback;"function"==typeof s&&s()})}function h(t,a){var i;t.find(".btn-save").on("click",function(){i=e(this);var o=i.closest(".easy-grid-row"),n=o.find(".invalid");if(n.length>0)return void b(n,6,200,"invalid-bg");if("function"==typeof a){var s=p(o),d=a(s);if(d){var r;i.closest(".easy-grid-row").find(".edit-status").each(function(){r=this.value,e(this).parent().html(r)}),i.hide().siblings(".btn-cancel, .btn-undo").hide().siblings(".btn-update, .btn-del").show().closest(".easy-grid-row").removeClass("row-editable");try{e(t.data("easyGridConf").addRowSelector).removeClass("off")}catch(e){console.warn(e)}}else console.warn("保存失败")}var l=t.data("easyGridConf").savedCallback;"function"==typeof l&&l(o)})}function y(t){var a;t.find(".btn-cancel").on("click",function(){var t;a=e(this),a.closest(".easy-grid-row").find(".edit-status").each(function(){t=this.getAttribute("placeholder"),e(this).parent().html(t)}),a.hide().siblings(".btn-save").hide().siblings(".btn-update, .btn-del").show().closest(".easy-grid-row").removeClass("row-editable")})}function v(t){t.find(".easy-grid-body .select-row").on("click",function(){e(this).closest(".easy-grid-row").toggleClass("selected")}),t.find(".easy-grid-header .select-row").on("click",function(a){var i=e(this),o=t.find(".easy-grid-body");if(1===o.children(".grid-row-model").length&&1===o.children(".easy-grid-row").length)return void a.preventDefault();var n=i.closest(".easy-grid-row");n.hasClass("selected")?(t.find(".easy-grid-body .easy-grid-row:not(.grid-row-model)").find(".select-row:checked").trigger("click"),n.removeClass("selected")):(t.find(".easy-grid-body .easy-grid-row:not(.grid-row-model)").find(".select-row:not(:checked)").trigger("click"),n.addClass("selected"))})}function g(t,a){a.on("click",function(){var a=[],i=t.data("easyGridConf").delRowsFn,o=t.find(".easy-grid-body .easy-grid-row.selected");if(o.each(function(){a.push(p(e(this)))}),"function"==typeof i){var n=i(a);n?(t.find(".easy-grid-header > .easy-grid-row").hasClass("selected")&&t.find(".select-row-all").trigger("click"),o.animate({height:0,opacity:0},300,function(){o.remove()})):console.error("批量删除失败")}})}function p(t){var a,i={};return t.hasClass("row-editable")?t.find("[data-key]").each(function(){a=e(this),i[a.attr("data-key")]=a.children(".edit-status").val()}):t.find("[data-key]").each(function(){a=e(this),i[a.attr("data-key")]=a.text()}),i}function w(t){var a=t.data;return e.isArray(a)?("undefined"==typeof a[0],!0):(console.error('"data"参数应该是对象数组或二维数组!'),!1)}function b(t,a,i,o){t.each(function(){var t=e(this),n=0,s=setInterval(function(){t.toggleClass(o),n++>a&&(clearInterval(s),t.removeClass(o))},i)})}var C={dataFlag:0,showHeader:!1,showSelectCol:!1,selectColWidth:"0",showAddRow:!1,showOperateCol:!1,addRowPosition:"end",delRowsSelector:"",delRowsFn:"",addRowPrimaryKey:[],addRowPrimaryKeyDefaultVal:[],primaryKey:[],valMap:!1,showPager:!1,pagerSize:10},m=e.extend(C,t);return this.each(function(){var t=w(m);if(t){var i=e(this);i.data("easyGridConf",m),a(i),n(i),s(i),"function"==typeof m.renderedCallback&&m.renderedCallback()}})}}(jQuery);