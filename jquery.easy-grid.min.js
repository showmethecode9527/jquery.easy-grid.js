!function(e){"use strict";e.fn.easyGrid=function(t){function a(e){var t=e.data("easyGridConf"),a=parseInt(t.dataFlag,10),s=t.showHeader,n=t.showOperateCol,d=t.showSelectCol,r=t.data,l=r.length,c='<div class="easy-grid">';if(0===a){var f,u=t.colKey,h={colKey:u,showSelectCol:d,showOperateCol:n,operateCol:t.operateCol};if("false"===s.toString())0!==l?c+=o(r,h):(f={},u.forEach(function(e){f[e]=""}),c+=o([f],h));else{var y=t.header;c+=i(y,d,n,t.operateCol),0!==l?c+=o(r,h):(f={},u.forEach(function(e){f[e]=""}),c+=o([f],h,!0))}}else console.log("源数据是二维数组");c+="</div>",e.html(c)}function i(e,t,a,i){if("undefined"==typeof e)return"";var o='<div class="easy-grid-header"><div class="easy-grid-row">';return"true"===t.toString()&&(o+='<div class="easy-grid-col col-select"><input type="checkbox" class="select-row select-row-all"></div>'),e.forEach(function(e){o+='<div class="easy-grid-col col-default">'+e+"</div>"}),"true"===a.toString()&&(o+='<div class="easy-grid-col col-operate">'+i.header+"</div>"),o+="</div></div>"}function o(e,t,a){var i=t.colKey,o=t.showOperateCol,s=t.showSelectCol,n=t.operateCol,d="",r="",l="",c="";"undefined"!=typeof n&&("undefined"!=typeof n.update&&(d=n.update.text||""),"undefined"!=typeof n.del&&(r=n.del.text||""),"undefined"!=typeof n.save&&(l=n.save.text||""),"undefined"!=typeof n.cancel&&(c=n.cancel.text||""));var f='<div class="easy-grid-body">';return"undefined"==typeof i?console.log("源数据是二维数组"):e.forEach(function(e){f+=a?'<div class="easy-grid-row grid-row-model">':'<div class="easy-grid-row">',"true"===s.toString()&&(f+='<div class="easy-grid-col col-select"><input type="checkbox" class="select-row"></div>'),i.forEach(function(t){f+='<div class="easy-grid-col col-default" data-key="'+t+'">'+e[t]+"</div>"}),"true"===o.toString()&&(f+='<div class="easy-grid-col col-operate"><button class="btn btn-operate btn-update">'+d+'</button><button class="btn btn-operate btn-del">'+r+'</button><button class="btn btn-operate btn-save">'+l+'</button><button class="btn btn-operate btn-cancel">'+c+'</button><button class="btn btn-operate btn-undo">'+c+"</button></div>"),f+="</div>"}),f+="</div>"}function s(t){var a=t.data("easyGridConf"),i=a.showSelectCol.toString(),o=a.showOperateCol.toString(),s=a.colWidth;if("undefined"!=typeof s){if(e.isArray(s)){var n=0,d=a.selectColWidth;try{n=a.operateCol.width}catch(e){console.log(e)}var r;t.find(".easy-grid-row").each(function(){r=e(this),r.children(".col-default").each(function(t){0===parseInt(s[t],10)&&e(this).addClass("hide"),this.style.width=s[t]}),"true"===i&&(r.children(".col-select")[0].style.width=d),"true"===o&&(r.children(".col-operate")[0].style.width=n)})}t.find(".btn-save, .btn-cancel, .btn-undo").hide()}}function n(t){var a=t.data("easyGridConf"),i=a.showOperateCol,o=a.showSelectCol,s=a.delRowsSelector,n=a.showAddRow;a.pattern;if("true"===i.toString()){var r=a.operateCol.save.fn,l=a.operateCol.del.fn;c(t,a.primaryKey),y(t),u(t,l),h(t,r),"true"===n.toString()&&d(t,e(a.addRowSelector),a.addRowPosition)}if("true"===o.toString()){g(t);var f=e(s);0!==f.length&&v(t,f)}}function d(t,a,i){a.on("click",function(){if(!e(this).hasClass("off")){e(this).addClass("off");var a=t.find(".easy-grid-body");r(t,a,i)}})}function r(t,a,i){var o;o="start"===i?a.children(".easy-grid-row:eq(0)").clone(!0).removeClass("grid-row-model"):a.children(".easy-grid-row:last").clone(!0).removeClass("grid-row-model");var s,n,d=t.data("easyGridConf").addRowPrimaryKey,r=t.data("easyGridConf").addRowPrimaryKeyDefaultVal;o.hasClass("row-editable")?(o.find(".edit-status").val("").attr("placeholder","").end().find(".btn-cancel").hide().siblings(".btn-undo").show(),o.find(".col-default").each(function(){s=e(this),n=e.inArray(s.attr("data-key"),d),n===-1?s.children(".edit-status").removeAttr("disabled"):s.children(".edit-status").val(r[n])}),"start"===i?o.prependTo(a):a.append(o),o.find(".edit-status:eq(0)").focus(),l(t)):(o.addClass("row-editable").find(".col-default").each(function(){s=e(this),n=e.inArray(s.attr("data-key"),d),n===-1?s.html('<input type="text" class="edit-status" placeholder="">'):s.html('<input type="text" class="edit-status" disabled title="该项不可修改" placeholder="">').find(".edit-status").val(r[n])}).siblings(".col-operate").find(".btn-update, .btn-del, .btn-cancel").hide().siblings(".btn-save, .btn-undo").show(),"start"===i?o.prependTo(a):a.append(o),o.find(".edit-status:eq(0)").focus(),l(t),f(t))}function l(t){t.find(".btn-undo").on("click",function(){e(this).closest(".easy-grid-row").animate({height:0,opacity:0},300,function(){try{e(t.data("easyGridConf").addRowSelector).removeClass("off")}catch(e){console.warn(e)}e(this).remove()})})}function c(t,a){var i,o,s;t.find(".btn-update").on("click",function(){s=e(this),s.hide().siblings(".btn-del").hide().siblings(".btn-save, .btn-cancel").show().closest(".col-operate").siblings(".col-default").each(function(){i=e(this),o=i.text(),e.inArray(i.attr("data-key"),a)>-1?i.html('<input type="text" class="edit-status" disabled title="该项不可修改" placeholder="'+o+'">').children(".edit-status").val(o):i.html('<input type="text" class="edit-status can-update" placeholder="'+o+'">').children(".edit-status").val(o)}),s.closest(".easy-grid-row").addClass("row-editable").find(".edit-status.can-update:eq(0)").focus().select(),f(t)})}function f(t){var a=t.data("easyGridConf").pattern;e(".edit-status").on("keyup",function(t){var i=e(this),o=i.parent(".easy-grid-col").attr("data-key");a.hasOwnProperty(o)&&(a[o].test(i.val())?i.removeClass("invalid"):i.addClass("invalid"))})}function u(t,a){t.find(".btn-del").on("click",function(){if("function"==typeof a){var t=e(this).closest(".easy-grid-row"),i=w(t),o=a(i);o?e(this).closest(".easy-grid-row").animate({height:0,opacity:0},300,"swing",function(){e(this).remove()}):console.warn("删除失败")}})}function h(t,a){var i;t.find(".btn-save").on("click",function(){if("function"==typeof a){var o=e(this).closest(".easy-grid-row"),s=w(o),n=a(s);if(n){var d;i=e(this),i.closest(".easy-grid-row").find(".edit-status").each(function(){d=this.value,e(this).parent().html(d)}),i.hide().siblings(".btn-cancel, .btn-undo").hide().siblings(".btn-update, .btn-del").show().closest(".easy-grid-row").removeClass("row-editable");try{e(t.data("easyGridConf").addRowSelector).removeClass("off")}catch(e){console.warn(e)}}else console.warn("保存失败")}})}function y(t){var a;t.find(".btn-cancel").on("click",function(){var t;a=e(this),a.closest(".easy-grid-row").find(".edit-status").each(function(){t=this.getAttribute("placeholder"),e(this).parent().html(t)}),a.hide().siblings(".btn-save").hide().siblings(".btn-update, .btn-del").show().closest(".easy-grid-row").removeClass("row-editable")})}function g(t){t.find(".easy-grid-body .select-row").on("click",function(){e(this).closest(".easy-grid-row").toggleClass("selected")}),t.find(".easy-grid-header .select-row").on("click",function(a){var i=e(this),o=t.find(".easy-grid-body");if(1===o.children(".grid-row-model").length&&1===o.children(".easy-grid-row").length)return void a.preventDefault();var s=i.closest(".easy-grid-row");s.hasClass("selected")?(t.find(".easy-grid-body .easy-grid-row:not(.grid-row-model)").find(".select-row:checked").trigger("click"),s.removeClass("selected")):(t.find(".easy-grid-body .easy-grid-row:not(.grid-row-model)").find(".select-row:not(:checked)").trigger("click"),s.addClass("selected"))})}function v(t,a){a.on("click",function(){var a=[],i=t.data("easyGridConf").delRowsFn,o=t.find(".easy-grid-body .easy-grid-row.selected");if(o.each(function(){a.push(w(e(this)))}),"function"==typeof i){var s=i(a);s?(t.find(".easy-grid-header > .easy-grid-row").hasClass("selected")&&t.find(".select-row-all").trigger("click"),o.animate({height:0,opacity:0},300,function(){o.remove()})):console.error("批量删除失败")}})}function w(t){var a,i={};return t.hasClass("row-editable")?t.find("[data-key]").each(function(){a=e(this),i[a.attr("data-key")]=a.children(".edit-status").val()}):t.find("[data-key]").each(function(){a=e(this),i[a.attr("data-key")]=a.text()}),i}function p(t){var a=t.data;return e.isArray(a)?("undefined"==typeof a[0],!0):(console.error('"data"参数应该是对象数组或二维数组!'),!1)}var b={dataFlag:0,showHeader:!1,showSelectCol:!1,selectColWidth:"0",showAddRow:!1,showOperateCol:!1,addRowPosition:"end",delRowsSelector:"",delRowsFn:"",addRowPrimaryKey:[],addRowPrimaryKeyDefaultVal:[],primaryKey:[],showPager:!1,pagerSize:10,pattern:{}},C=e.extend(b,t);return this.each(function(){var t=p(C);if(t){var i=e(this);i.data("easyGridConf",C),a(i),s(i),n(i)}})}}(jQuery);